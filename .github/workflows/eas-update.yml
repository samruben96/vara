name: EAS Update (Preview)

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

jobs:
  update:
    name: EAS Update
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create EAS Update
        id: eas-update
        run: |
          # Create update for the PR branch
          eas update --branch pr-${{ github.event.pull_request.number }} --message "${{ github.event.pull_request.title }}" --non-interactive --json > update-output.json

          # Extract update info
          UPDATE_GROUP_ID=$(cat update-output.json | jq -r '.[0].group')
          echo "update_group_id=$UPDATE_GROUP_ID" >> $GITHUB_OUTPUT

      - name: Comment on PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const updateGroupId = '${{ steps.eas-update.outputs.update_group_id }}';
            const projectSlug = 'obytes/obytes-app'; // Update this to your Expo project slug

            const body = `## ðŸ“± EAS Update Preview Available

            A preview build has been created for this PR.

            **Update Group:** \`${updateGroupId}\`

            ### How to test:
            1. Install the Expo Go app or a development build
            2. Open the app and scan the QR code below, or
            3. Visit: [expo.dev](https://expo.dev/projects/${projectSlug}/updates/${updateGroupId})

            ---
            _This preview was automatically generated by the EAS Update workflow._`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('EAS Update Preview')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
